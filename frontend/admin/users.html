<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ - ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; overflow-y: auto; }
        .logo { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; }
        .logo h2 { font-size: 20px; }
        .user-info { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; }
        .role-badge { display: inline-block; padding: 4px 12px; background: rgba(255,255,255,0.2); border-radius: 12px; font-size: 12px; margin-top: 5px; }
        .menu { list-style: none; }
        .menu a { display: flex; align-items: center; padding: 12px 20px; color: white; text-decoration: none; transition: background 0.3s; }
        .menu a:hover, .menu a.active { background: rgba(255,255,255,0.2); }
        .menu a span { margin-right: 10px; font-size: 18px; }
        .main-content { margin-left: 260px; padding: 20px; }
        .header { background: white; padding: 20px 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; color: #333; }
        .btn-logout { padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #667eea; }
        .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
        .stat-card .number { font-size: 28px; font-weight: bold; color: #333; }
        .content-section { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .filter-group { display: flex; gap: 10px; flex: 1; }
        .filter-group select, .filter-group input { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; }
        .filter-group input { flex: 1; min-width: 200px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        table th { background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #333; font-size: 14px; }
        table td { padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; color: #666; }
        table tr:hover { background: #f8f9fa; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-admin { background: #e3f2fd; color: #1976d2; }
        .badge-technician { background: #fff3e0; color: #f57c00; }
        .badge-user { background: #f3e5f5; color: #7b1fa2; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-inactive { background: #f8d7da; color: #721c24; }
        .btn-action { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px; }
        .btn-make-admin { background: #3498db; color: white; }
        .btn-remove-admin { background: #f39c12; color: white; }
        .btn-deactivate { background: #e74c3c; color: white; }
        .loading { text-align: center; padding: 40px; color: #667eea; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"><h2>üîß ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h2></div>
        <div class="user-info">
            <p><strong id="userName">Loading...</strong></p>
            <span class="role-badge" id="userRole">Loading...</span>
        </div>
        <ul class="menu">
            <li><a href="dashboard.html"><span>üìä</span> Dashboard</a></li>
            <li><a href="all-requests.html"><span>üìã</span> ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a></li>
            <li><a href="equipment.html"><span>üñ•Ô∏è</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</a></li>
            <li><a href="users.html" class="active"><span>üë•</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a></li>
            <li><a href="reports.html"><span>üìà</span> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h1>
            <button class="btn-logout" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <div class="number" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <h3>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <div class="number" id="totalAdmins">0</div>
            </div>
            <div class="stat-card">
                <h3>‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</h3>
                <div class="number" id="totalTechnicians">0</div>
            </div>
            <div class="stat-card">
                <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                <div class="number" id="totalRegularUsers">0</div>
            </div>
        </div>

        <div class="content-section">
            <div class="toolbar">
                <div class="filter-group">
                    <select id="roleFilter" onchange="loadUsers()">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</option>
                        <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                        <option value="technician">‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</option>
                        <option value="user">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                    </select>
                    <input type="search" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ..." onkeyup="loadUsers()">
                </div>
            </div>

            <div class="table-container">
                <div id="usersLoading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                <div id="usersContainer" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/js/auth.js"></script>
    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        
        if (!requireAuth()) {}
        
        const currentUser = getCurrentUser();
        const userRole = getUserRole();
        
        if (userRole !== 'admin') {
            alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
            if (userRole === 'technician') {
                window.location.href = '../technician/assigned-jobs.html';
            } else {
                window.location.href = '../user/dashboard.html';
            }
        }

        const token = localStorage.getItem('access_token');

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/roles_summary/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalUsers').textContent = data.total || 0;
                    document.getElementById('totalAdmins').textContent = data.admins || 0;
                    document.getElementById('totalTechnicians').textContent = data.technicians || 0;
                    document.getElementById('totalRegularUsers').textContent = data.users || 0;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function getRoleText(userObj) {
            if (userObj.is_superuser) return '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î';
            if (userObj.is_staff) return '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
            if (userObj.role === 'technician') return '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ';
            return '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        }

        function getRoleBadgeClass(userObj) {
            if (userObj.is_superuser || userObj.is_staff) return 'badge-admin';
            if (userObj.role === 'technician') return 'badge-technician';
            return 'badge-user';
        }

        async function loadUsers() {
            try {
                const roleFilter = document.getElementById('roleFilter').value;
                const search = document.getElementById('searchInput').value;

                let endpoint = `${API_BASE_URL}/api/users/?ordering=-date_joined`;
                
                if (roleFilter) endpoint += `&role=${roleFilter}`;
                if (search) endpoint += `&search=${search}`;

                const response = await fetch(endpoint, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load users');

                const data = await response.json();
                const users = data.results || data;

                document.getElementById('usersLoading').style.display = 'none';
                document.getElementById('usersContainer').style.display = 'block';

                const tbody = document.getElementById('usersBody');
                tbody.innerHTML = users.map(u => {
                    const isCurrentUser = u.id === currentUser.id;
                    const canModify = !isCurrentUser && !u.is_superuser;

                    let actions = '';
                    if (canModify) {
                        if (u.is_staff) {
                            actions += `<button class="btn-action btn-remove-admin" onclick="removeAdmin(${u.id})">‡∏•‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</button>`;
                        } else {
                            actions += `<button class="btn-action btn-make-admin" onclick="makeAdmin(${u.id})">‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô Admin</button>`;
                        }
                        
                        if (u.is_active) {
                            actions += `<button class="btn-action btn-deactivate" onclick="toggleActive(${u.id}, false)">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>`;
                        } else {
                            actions += `<button class="btn-action btn-make-admin" onclick="toggleActive(${u.id}, true)">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>`;
                        }
                    } else if (isCurrentUser) {
                        actions = '<span style="color: #999; font-size: 12px;">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>';
                    } else {
                        actions = '<span style="color: #999; font-size: 12px;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ</span>';
                    }

                    return `
                        <tr>
                            <td><strong>${u.username}</strong></td>
                            <td>${u.full_name || '-'}</td>
                            <td>${u.email || '-'}</td>
                            <td><span class="badge ${getRoleBadgeClass(u)}">${getRoleText(u)}</span></td>
                            <td><span class="badge ${u.is_active ? 'badge-active' : 'badge-inactive'}">${u.is_active ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}</span></td>
                            <td>${actions}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('usersLoading').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
            }
        }

        async function makeAdmin(userId) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}/make_admin/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    loadUsers();
                    loadStats();
                } else {
                    throw new Error('Failed');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        async function removeAdmin(userId) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}/remove_admin/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('‡∏•‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    loadUsers();
                    loadStats();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function toggleActive(userId, isActive) {
            const action = isActive ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£${action}‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });

                if (response.ok) {
                    alert(`${action}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    loadUsers();
                } else {
                    throw new Error('Failed');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        loadStats();
        loadUsers();
    </script>
</body>
</html>